<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guardian Ghost Demo</title>

    <!-- React + ReactDOM + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>


    <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>


    <style>
:root {
  --bg: #0b0f17;
  --ghost-bg: #1b2233;
  --accent: #b794f6;
  --accent-2: #9d7df0;
  --bubble-user: #ffffff10;
  --bubble-ghost: #b794f620;
  --text-color: #e6eef8;
  --text-muted: #9aa3b5;
}

body {
  margin: 0;
  font-family: "Inter", sans-serif;
  background: var(--bg);
  color: var(--text-color);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.chat-container {
  display: flex;
  flex-direction: column;
  background: var(--ghost-bg);
  width: 100%;
  max-width: 420px;
  height: 95vh;
  border-radius: 20px;
  box-shadow: 0 0 30px rgba(183, 148, 246, 0.15);
  overflow: hidden;
  position: relative;
}

/* header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,0.05);
  padding: 14px 16px;
}

.header .title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 16px;
}

.header img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
}

/* chat area */
.chat {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  scroll-behavior: smooth;
}

/* ghost + user messages */
.message {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.message.user {
  justify-content: flex-end;
}

.bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 14px;
  line-height: 1.5;
  word-break: break-word;
  white-space: pre-wrap;
  overflow-wrap: anywhere;
  box-sizing: border-box;
  animation: fadeIn 0.2s ease-in;
}

.message.ghost .bubble {
  background: var(--bubble-ghost);
  color: var(--text-color);
}

.message.user .bubble {
  background: var(--bubble-user);
  color: var(--text-color);
}

/* ghost icon beside chat */
.ghost-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #b794f6;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
}

/* input area */
.input-area {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,0.07);
  border-radius: 25px;
  margin: 10px;
  padding: 6px 10px;
  box-sizing: border-box;
}

input.msg {
  flex: 1;
  background: transparent;
  border: none;
  color: white;
  font-size: 14px;
  padding: 10px;
  outline: none;
}

button.send {
  background: var(--accent-2);
  border: none;
  color: white;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  font-size: 18px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: 0.2s;
}

button.send:hover {
  background: var(--accent);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* mobile fix */
@media (max-width: 400px) {
  .chat-container {
    border-radius: 0;
    height: 100vh;
  }
}
    
      .phone {
  width: 100%;
  max-width: 420px;
  height: 95vh;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background: var(--ghost-bg);
  border-radius: 20px;
  box-shadow: 0 0 30px rgba(183, 148, 246, 0.15);
  overflow: hidden;
}

/* header bar at top */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: rgba(255,255,255,0.05);
  font-size: 16px;
  font-weight: 600;
  color: var(--text-color);
}

/* language switch button */
.lang-toggle {
  background: var(--accent-2);
  color: white;
  border: none;
  border-radius: 16px;
  padding: 4px 10px;
  cursor: pointer;
  transition: 0.2s;
}
.lang-toggle:hover {
  background: var(--accent);
}


</style>
</head>
  <body>
    <!-- スタートメニュー画面 -->
    <div id="start-screen" class="screen active">
      <h1>👻 Guardian Ghost</h1>
      <p>ようこそ。ゴーストに会う準備はできた？</p>
      <button id="scanButton">スキャンモードを開始</button>
    </div>

    <!-- QRスキャンモード（仮の画面） -->
    <div id="scan-screen" class="screen">
      <h1>🔍 スキャンモード</h1>
      <div id="qr-reader" style="width: 260px; margin: 20px auto;"></div>

<p id="qr-result"></p>

      <button id="goToGhost">ゴーストの世界へ</button>
    </div>

    <!-- ゴーストアプリ本体 -->
    <div id="ghost-app" class="screen">
      <div id="root"></div>
    </div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const DICT = {
        ja: {
          title: "Guardian Ghost",
          welcome: "ようこそ Guardian Ghost へ",
          placeholder: "メッセージを入力…",
          english: "English",
          japanese: "日本語",
          timeUp: "時間だ…また会おうね👻",
          remaining: "残り時間",
        },
        en: {
          title: "Guardian Ghost",
          welcome: "Welcome to Guardian Ghost",
          placeholder: "Type a message…",
          english: "English",
          japanese: "日本語",
          timeUp: "My time is up... see you soon 👻",
          remaining: "Time left",
        },
      };

      const PERSONALITIES = {
        kind: {
          system: "You are a kind guardian ghost.",
          replies: [
            "大丈夫、私はここにいるよ 🌙",
            "焦らないで、ゆっくりでいいんだよ。",
            "あなたはよく頑張ってるね 💫",
          ],
          color: "rgba(179, 146, 255, 0.85)",
        },
        cool: {
          system: "You are a calm, mysterious ghost.",
          replies: ["Yo.", "Stay chill.", "静かな夜だな。"],
          color: "rgba(110, 231, 183, 0.85)",
        },
      };

      function GhostSVG({ color }) {
        return (
          <div className="ghost" style={{ backgroundColor: color, borderRadius: "50%" }}>
            <svg viewBox="0 0 128 128">
              <path fill="#fff" d="M64 8c-22 0-40 18-40 40v32c0 4 3 7 7 7 4 0 6-3 10-3s6 3 10 3 6-3 10-3 6 3 10 3 6-3 10-3 6 3 10 3c4 0 7-3 7-7V48c0-22-18-40-40-40z"/>
              <circle cx="46" cy="56" r="6" fill="#091019" />
              <circle cx="82" cy="56" r="6" fill="#091019" />
            </svg>
          </div>
        );
      }

      function App({ personality }) {
        const [lang, setLang] = useState("ja");
        const t = DICT[lang];
        const [messages, setMessages] = useState([{ from: "ghost", text: t.welcome }]);
        const [input, setInput] = useState("");
        const [timeLeft, setTimeLeft] = useState(15 * 60);
        const [active, setActive] = useState(true);
        const chatRef = useRef(null);

        useEffect(() => { setMessages([{ from: "ghost", text: DICT[lang].welcome }]); }, [lang]);
        useEffect(() => { if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight; }, [messages]);

        useEffect(() => {
          if (!active) return;
          const timer = setInterval(() => {
            setTimeLeft(prev => {
              if (prev <= 1) {
                clearInterval(timer);
                setActive(false);
                setMessages(prev => [...prev, { from: "ghost", text: t.timeUp }]);
                return 0;
              }
              return prev - 1;
            });
          }, 1000);
          return () => clearInterval(timer);
        }, [active, lang]);

        const sendMessage = async () => {
          if (!input || !active) return;
          const userMsg = input;
          setMessages(prev => [...prev, { from: "user", text: userMsg }]);
          setInput("");

          try {
            const response = await fetch("https://guardian-ghost.onrender.com/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ message: userMsg, personality: PERSONALITIES[personality].system }),
});
const data = await response.json();
setMessages(prev => [...prev, { from: "ghost", text: data.reply }]);

                    } catch (err) {
            setMessages(prev => [
              ...prev,
              { from: "ghost", text: "Connection lost... I can’t reach my world 👻" },
            ]);
          }
        };

        const formatTime = (seconds) => {
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        };

        return (
          <div className="phone">
            <header className="app-header">
              <div style={{ fontWeight: 700, fontSize: 16 }}>{t.title}</div>
              <button className="lang-toggle" onClick={() => setLang(lang === "ja" ? "en" : "ja")}>
                {lang === "ja" ? t.english : t.japanese}
              </button>
            </header>
           <main className="chat-screen">
              <div style={{ textAlign: "center", fontSize: 13, color: "#94a3b8" }}>
                {t.remaining}: {formatTime(timeLeft)}
              </div>
              <GhostSVG color={PERSONALITIES[personality].color} />
              <div className="chat" ref={chatRef}>
                {messages.map((m, i) => (
               
            <div
  key={i}
  className={`message ${m.from}`}
>
  {m.from === "ghost" && <div className="ghost-avatar">👻</div>}
  <div className="bubble">{m.text}</div>
</div>
  ))}
</div>
              <div className="input-area">
                <input
                  className="msg"
                  value={input}
                  placeholder={t.placeholder}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => e.key === "Enter" && sendMessage()}
                  disabled={!active}
                />
             <button className="send" onClick={sendMessage} disabled={!active}>
  <i class="fa fa-paper-plane"></i>
</button>

              </div>
            </main>
          </div>
        );
      }

      // ✅ Start app and render with selected personality
      let selectedPersonality = "kind"; // default
let qrReader;


      document.getElementById("scanButton").addEventListener("click", () => {
        document.getElementById("start-screen").classList.remove("active");
        document.getElementById("scan-screen").classList.add("active");
startQR();
      });

   

  function startQR() {
    const qrResult = document.getElementById("qr-result");
    qrReader = new Html5Qrcode("qr-reader");

    qrReader.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 200 },
      (decodedText) => {
        qrReader.stop();

        qrResult.innerText = `Scanned: ${decodedText}`;


        if (decodedText.includes("kind")) {
          selectedPersonality = "kind";
        } else if (decodedText.includes("cool")) {
          selectedPersonality = "cool";
        } else {
          selectedPersonality = "kind";
        }

        alert(`選ばれた性格: ${selectedPersonality}`);

        document.getElementById("scan-screen").classList.remove("active");
        document.getElementById("ghost-app").classList.add("active");

        setTimeout(() => startApp(), 300);
      },
      (errorMessage) => {
        // console.log("QR scanning...", errorMessage);
      }
    );
  }

  // ✅ Reactが確実にDOMを読み込んでから起動
 

     function startApp() {
  const rootEl = document.getElementById("root");
  if (!rootEl) {
    console.error("Root element not found!");
    return;
  }
  ReactDOM.createRoot(rootEl).render(
    <App personality={selectedPersonality} />
  );
}

    </script>
  </body>
</html>




