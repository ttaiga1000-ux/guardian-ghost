<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guardian Ghost Demo</title>

    <!-- React + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
      :root {
        --bg: #0b0f17;
        --panel: #0f1720;
        --muted: #94a3b8;
        --accent: #6ee7b7;
        --accent-2: #b392ff;
        --danger: #ff6b6b;
        --glass: rgba(255, 255, 255, 0.03);
      }

      html,
      body,
      #root {
        height: 100%;
        margin: 0;
      }

      body {
        background: radial-gradient(1200px 600px at 10% 10%, rgba(179,146,255,0.05), transparent),
          radial-gradient(1200px 600px at 90% 90%, rgba(110,231,183,0.04), transparent), var(--bg);
        color: #e6eef8;
        font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Inter", sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* --- Phone container --- */
      .phone {
        width: min(360px, 92vw);
        height: min(720px, 88vh);
        border-radius: 28px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
        box-shadow: 0 10px 40px rgba(2, 6, 23, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.03);
        padding: 18px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }

      header.app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 6px;
      }

      .lang-toggle {
        font-size: 13px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--glass);
        color: var(--muted);
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .chat-screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .ghost {
        width: 90px;
        height: 90px;
        margin: 10px auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 8px;
      }

      .bubble {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 20px;
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
        white-space: pre-wrap;
        animation: pop 0.2s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .bubble.user {
        align-self: flex-end;
        background: rgba(255, 255, 255, 0.9);
        color: #0b0f17;
        border-bottom-right-radius: 4px;
      }

      .bubble.ghost {
        align-self: flex-start;
        background: rgba(179, 146, 255, 0.9);
        color: #0b0f17;
        border-bottom-left-radius: 4px;
      }

      .input-area {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 0;
      }

      input.msg {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: #e6eef8;
        outline: none;
        font-size: 14px;
      }

      button.send {
        padding: 10px 14px;
        border-radius: 999px;
        background: var(--accent-2);
        border: none;
        font-weight: 700;
        cursor: pointer;
        color: #071322;
        transition: 0.3s;
      }

      button.send:hover {
        background: var(--accent);
      }

      @keyframes pop {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* --- Screen switching --- */
      .screen {
        display: none;
        text-align: center;
        animation: fadeIn 1.5s ease-in-out;
      }

      .active {
        display: block;
      }

      button {
        background: white;
        color: black;
        border: none;
        padding: 15px 30px;
        font-size: 1.1em;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 15px;
      }

      button:hover {
        background: #222;
        color: white;
        border: 1px solid white;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <!-- Start Screen -->
    <div id="start-screen" class="screen active">
      <h1>üëª Guardian Ghost</h1>
      <p>„Çà„ÅÜ„Åì„Åù„ÄÇ„Ç¥„Éº„Çπ„Éà„Å´‰ºö„ÅÜÊ∫ñÂÇô„ÅØ„Åß„Åç„ÅüÔºü</p>
      <button id="scanButton">„Çπ„Ç≠„É£„É≥„É¢„Éº„Éâ„ÇíÈñãÂßã</button>
    </div>

    <!-- Scan Screen -->
    <div id="scan-screen" class="screen">
      <h1>üîç „Çπ„Ç≠„É£„É≥„É¢„Éº„Éâ</h1>
      <div id="qr-reader" style="width: 260px; margin: 20px auto;"></div>
      <p id="qr-result"></p>
      <button id="goToGhost">„Ç¥„Éº„Çπ„Éà„ÅÆ‰∏ñÁïå„Å∏</button>
    </div>

    <!-- Ghost App -->
    <div id="ghost-app" class="screen">
      <div id="root"></div>
    </div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const DICT = {
        ja: {
          title: "Guardian Ghost",
          welcome: "„Çà„ÅÜ„Åì„Åù Guardian Ghost „Å∏",
          placeholder: "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ‚Ä¶",
          english: "English",
          japanese: "Êó•Êú¨Ë™û",
          timeUp: "ÊôÇÈñì„Å†‚Ä¶„Åæ„Åü‰ºö„Åä„ÅÜ„Å≠üëª",
          remaining: "ÊÆã„ÇäÊôÇÈñì",
        },
        en: {
          title: "Guardian Ghost",
          welcome: "Welcome to Guardian Ghost",
          placeholder: "Type a message‚Ä¶",
          english: "English",
          japanese: "Êó•Êú¨Ë™û",
          timeUp: "My time is up... see you soon üëª",
          remaining: "Time left",
        },
      };

      const PERSONALITIES = {
        kind: {
          system: "You are a kind guardian ghost.",
          replies: [
            "Â§ß‰∏àÂ§´„ÄÅÁßÅ„ÅØ„Åì„Åì„Å´„ÅÑ„Çã„Çà üåô",
            "ÁÑ¶„Çâ„Å™„ÅÑ„Åß„ÄÅ„ÇÜ„Å£„Åè„Çä„Åß„ÅÑ„ÅÑ„Çì„Å†„Çà„ÄÇ",
            "„ÅÇ„Å™„Åü„ÅØ„Çà„ÅèÈ†ëÂºµ„Å£„Å¶„Çã„Å≠ üí´",
          ],
          color: "rgba(179, 146, 255, 0.85)",
        },
        cool: {
          system: "You are a calm, mysterious ghost.",
          replies: ["Yo.", "Stay chill.", "Èùô„Åã„Å™Â§ú„Å†„Å™„ÄÇ"],
          color: "rgba(110, 231, 183, 0.85)",
        },
      };

      function GhostSVG({ color }) {
        return (
          <div className="ghost" style={{ backgroundColor: color, borderRadius: "50%" }}>
            <svg viewBox="0 0 128 128" width="60" height="60">
              <path
                fill="#fff"
                d="M64 8c-22 0-40 18-40 40v32c0 4 3 7 7 7 4 0 6-3 10-3s6 3 10 3 6-3 10-3 6 3 10 3 6-3 10-3 6 3 10 3c4 0 7-3 7-7V48c0-22-18-40-40-40z"
              />
              <circle cx="46" cy="56" r="6" fill="#091019" />
              <circle cx="82" cy="56" r="6" fill="#091019" />
            </svg>
          </div>
        );
      }

      function App({ personality }) {
        const [lang, setLang] = useState("ja");
        const t = DICT[lang];
        const [messages, setMessages] = useState([{ from: "ghost", text: t.welcome }]);
        const [input, setInput] = useState("");
        const [timeLeft, setTimeLeft] = useState(15 * 60);
        const [active, setActive] = useState(true);
        const chatRef = useRef(null);

        useEffect(() => {
          setMessages([{ from: "ghost", text: DICT[lang].welcome }]);
        }, [lang]);

        useEffect(() => {
          if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
        }, [messages]);

        useEffect(() => {
          if (!active) return;
          const timer = setInterval(() => {
            setTimeLeft((prev) => {
              if (prev <= 1) {
                clearInterval(timer);
                setActive(false);
                setMessages((prev) => [...prev, { from: "ghost", text: t.timeUp }]);
                return 0;
              }
              return prev - 1;
            });
          }, 1000);
          return () => clearInterval(timer);
        }, [active, lang]);

        const sendMessage = async () => {
          if (!input || !active) return;
          const userMsg = input;
          setMessages((prev) => [...prev, { from: "user", text: userMsg }]);
          setInput("");

          try {
            const response = await fetch("https://guardian-ghost.onrender.com/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: userMsg,
                personality: PERSONALITIES[personality].system,
              }),
            });

            const data = await response.json();
            setMessages((prev) => [...prev, { from: "ghost", text: data.reply }]);
          } catch (err) {
            setMessages((prev) => [
              ...prev,
              { from: "ghost", text: "Connection lost... I can‚Äôt reach my world üëª" },
            ]);
          }
        };

        const formatTime = (seconds) => {
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        };

        return (
          <div className="phone">
            <header className="app-header">
              <div style={{ fontWeight: 700, fontSize: 16 }}>{t.title}</div>
              <button
                className="lang-toggle"
                onClick={() => setLang(lang === "ja" ? "en" : "ja")}
              >
                {lang === "ja" ? t.english : t.japanese}
              </button>
            </header>

            <main className="chat-screen">
              <div style={{ textAlign: "center", fontSize: 13, color: "#94a3b8" }}>
                {t.remaining}: {formatTime(timeLeft)}
              </div>

              <GhostSVG color={PERSONALITIES[personality].color} />

              <div className="chat" ref={chatRef}>
                {messages.map((m, i) => (
                  <div key={i} className={`bubble ${m.from}`}>
                    {m.text}
                  </div>
                ))}
              </div>

              <div className="input-area">
                <input
                  className="msg"
                  value={input}
                  placeholder={t.placeholder}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => e.key === "Enter" && sendMessage()}
                  disabled={!active}
                />
                <button className="send" onClick={sendMessage} disabled={!active}>
                  ‚Üí
                </button>
              </div>
            </main>
          </div>
        );
      }

      // --- QR and App startup logic ---
      let selectedPersonality = "kind";
      let qrReader;

      document.getElementById("scanButton").addEventListener("click", () => {
        document.getElementById("start-screen").classList.remove("active");
        document.getElementById("scan-screen").classList.add("active");
        startQR();
      });

      function startQR() {
        const qrResult = document.getElementById("qr-result");
        qrReader = new Html5Qrcode("qr-reader");

        qrReader.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 200 },
          (decodedText) => {
            qrReader.stop();
            qrResult.innerText = `Scanned: ${decodedText}`;
            if (decodedText.includes("kind")) selectedPersonality = "kind";
            else if (decodedText.includes("cool")) selectedPersonality = "cool";
            else selectedPersonality = "kind";

            alert(`ÈÅ∏„Å∞„Çå„ÅüÊÄßÊ†º: ${selectedPersonality}`);
            document.getElementById("scan-screen").classList.remove("active");
            document.getElementById("ghost-app").classList.add("active");
            setTimeout(() => startApp(), 300);
          },
          (errorMessage) => {}
        );
      }

      function startApp() {
        const rootEl = document.getElementById("root");
        if (!rootEl) {
          console.error("Root element not found!");
          return;
        }
        ReactDOM.createRoot(rootEl).render(<App personality={selectedPersonality} />);
      }
    </script>
  </body>
</html>
