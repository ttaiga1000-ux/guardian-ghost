<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guardian Ghost Demo</title>

    <!-- React + ReactDOM + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>


    <style>
      :root {
        --bg: #0b0f17;
        --panel: #0f1720;
        --muted: #94a3b8;
        --accent: #6ee7b7;
        --accent-2: #b392ff;
        --danger: #ff6b6b;
        --glass: rgba(255, 255, 255, 0.03);
      }

      html, body, #root {
        height: 100%;
        margin: 0;
      }

      body {
        background: radial-gradient(1200px 600px at 10% 10%, rgba(179,146,255,0.05), transparent),
          radial-gradient(1200px 600px at 90% 90%, rgba(110,231,183,0.04), transparent),
          var(--bg);
        color: #e6eef8;
        font-family: "Hiragino Kaku Gothic ProN","Noto Sans JP","Inter",sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

.phone {
  width: 100%;
  max-width: 420px;
  height: 100%;
  max-height: 100vh;
  border-radius: 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  box-shadow: 0 10px 40px rgba(2,6,23,0.7);
  border: 1px solid rgba(255,255,255,0.03);
  padding: 12px;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-sizing: border-box;
}


      header.app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 6px;
      }

      .lang-toggle {
        font-size: 13px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--glass);
        color: var(--muted);
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.03);
      }

      .screen {
        margin-top: 6px;
        background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
        border-radius: 18px;
        padding: 14px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: hidden;
      }

      .ghost {
        width: 84px;
        height: 84px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

.chat {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 0 6px 10px;
  scroll-behavior: smooth;
}
.chat-message {
  display: flex;
  width: 100%;
  padding: 0 10px;
  box-sizing: border-box;
}

.chat-message.user {
  justify-content: flex-end;
}

.chat-message.ghost {
  justify-content: flex-start;
}

.chat::-webkit-scrollbar {
  width: 5px;
}
.chat::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
}


.bubble {
  display: inline-block; /* allows bubble height to expand naturally */
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.6;
  box-shadow: 0 4px 12px rgba(0,0,0,0.35);
  background: rgba(128, 90, 213, 0.2);
  color: #0b0f17;
  word-break: break-word;
  white-space: pre-wrap;
  overflow-wrap: anywhere; /* ensures words break nicely */
  margin-bottom: 6px;
  height: auto; /* this is important */
  overflow: visible; /* no clipping */
}



      .bubble.user {
        align-self: flex-end;
        background: rgba(255,255,255,0.9);
        color: #0b0f17;
        border-bottom-right-radius: 4px;
      }

      .bubble.ghost {
        align-self: flex-start;
        background: rgba(179,146,255,0.9);
        color: #0b0f17;
        border-bottom-left-radius: 4px;
      }

.input-area {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,0.05);
  border-radius: 25px;
  padding: 6px 10px;
  margin-top: 8px;
  box-sizing: border-box;
}

input.msg {
  flex: 1;
  background: transparent;
  border: none;
  color: white;
  font-size: 14px;
  padding: 10px;
  outline: none;
}

button.send {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  padding: 8px;
}

      @keyframes pop {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      .screen { display: none; text-align: center; animation: fadeIn 1.5s ease-in-out; }
      .active { display: block; }

      button {
        background: white; color: black; border: none;
        padding: 15px 30px; font-size: 1.1em;
        border-radius: 10px; cursor: pointer; transition: 0.3s; margin-top: 15px;
      }
      button:hover { background: #222; color: white; border: 1px solid white; }

      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  </head>

  <body>
    <!-- スタートメニュー画面 -->
    <div id="start-screen" class="screen active">
      <h1>👻 Guardian Ghost</h1>
      <p>ようこそ。ゴーストに会う準備はできた？</p>
      <button id="scanButton">スキャンモードを開始</button>
    </div>

    <!-- QRスキャンモード（仮の画面） -->
    <div id="scan-screen" class="screen">
      <h1>🔍 スキャンモード</h1>
      <div id="qr-reader" style="width: 260px; margin: 20px auto;"></div>

<p id="qr-result"></p>

      <button id="goToGhost">ゴーストの世界へ</button>
    </div>

    <!-- ゴーストアプリ本体 -->
    <div id="ghost-app" class="screen">
      <div id="root"></div>
    </div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const DICT = {
        ja: {
          title: "Guardian Ghost",
          welcome: "ようこそ Guardian Ghost へ",
          placeholder: "メッセージを入力…",
          english: "English",
          japanese: "日本語",
          timeUp: "時間だ…また会おうね👻",
          remaining: "残り時間",
        },
        en: {
          title: "Guardian Ghost",
          welcome: "Welcome to Guardian Ghost",
          placeholder: "Type a message…",
          english: "English",
          japanese: "日本語",
          timeUp: "My time is up... see you soon 👻",
          remaining: "Time left",
        },
      };

      const PERSONALITIES = {
        kind: {
          system: "You are a kind guardian ghost.",
          replies: [
            "大丈夫、私はここにいるよ 🌙",
            "焦らないで、ゆっくりでいいんだよ。",
            "あなたはよく頑張ってるね 💫",
          ],
          color: "rgba(179, 146, 255, 0.85)",
        },
        cool: {
          system: "You are a calm, mysterious ghost.",
          replies: ["Yo.", "Stay chill.", "静かな夜だな。"],
          color: "rgba(110, 231, 183, 0.85)",
        },
      };

      function GhostSVG({ color }) {
        return (
          <div className="ghost" style={{ backgroundColor: color, borderRadius: "50%" }}>
            <svg viewBox="0 0 128 128">
              <path fill="#fff" d="M64 8c-22 0-40 18-40 40v32c0 4 3 7 7 7 4 0 6-3 10-3s6 3 10 3 6-3 10-3 6 3 10 3 6-3 10-3 6 3 10 3c4 0 7-3 7-7V48c0-22-18-40-40-40z"/>
              <circle cx="46" cy="56" r="6" fill="#091019" />
              <circle cx="82" cy="56" r="6" fill="#091019" />
            </svg>
          </div>
        );
      }

      function App({ personality }) {
        const [lang, setLang] = useState("ja");
        const t = DICT[lang];
        const [messages, setMessages] = useState([{ from: "ghost", text: t.welcome }]);
        const [input, setInput] = useState("");
        const [timeLeft, setTimeLeft] = useState(15 * 60);
        const [active, setActive] = useState(true);
        const chatRef = useRef(null);

        useEffect(() => { setMessages([{ from: "ghost", text: DICT[lang].welcome }]); }, [lang]);
        useEffect(() => { if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight; }, [messages]);

        useEffect(() => {
          if (!active) return;
          const timer = setInterval(() => {
            setTimeLeft(prev => {
              if (prev <= 1) {
                clearInterval(timer);
                setActive(false);
                setMessages(prev => [...prev, { from: "ghost", text: t.timeUp }]);
                return 0;
              }
              return prev - 1;
            });
          }, 1000);
          return () => clearInterval(timer);
        }, [active, lang]);

        const sendMessage = async () => {
          if (!input || !active) return;
          const userMsg = input;
          setMessages(prev => [...prev, { from: "user", text: userMsg }]);
          setInput("");

          try {
            const response = await fetch("https://guardian-ghost.onrender.com/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ message: userMsg, personality: PERSONALITIES[personality].system }),
});
const data = await response.json();
setMessages(prev => [...prev, { from: "ghost", text: data.reply }]);

                    } catch (err) {
            setMessages(prev => [
              ...prev,
              { from: "ghost", text: "Connection lost... I can’t reach my world 👻" },
            ]);
          }
        };

        const formatTime = (seconds) => {
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        };

        return (
          <div className="phone">
            <header className="app-header">
              <div style={{ fontWeight: 700, fontSize: 16 }}>{t.title}</div>
              <button className="lang-toggle" onClick={() => setLang(lang === "ja" ? "en" : "ja")}>
                {lang === "ja" ? t.english : t.japanese}
              </button>
            </header>
           <main className="chat-screen">
              <div style={{ textAlign: "center", fontSize: 13, color: "#94a3b8" }}>
                {t.remaining}: {formatTime(timeLeft)}
              </div>
            <div style={{ textAlign: "center", marginBottom: "8px" }}>
  <GhostSVG color={PERSONALITIES[personality].color} />
</div>
<div className="chat" ref={chatRef}>
  {messages.map((m, i) => (
    <div key={i} className={`chat-message ${m.from}`}>
      <div className={`bubble ${m.from}`}>{m.text}</div>
    </div>
  ))}
</div>

              <div className="input-area">
                <input
                  className="msg"
                  value={input}
                  placeholder={t.placeholder}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => e.key === "Enter" && sendMessage()}
                  disabled={!active}
                />
                <button className="send" onClick={sendMessage} disabled={!active}>→</button>
              </div>
            </main>
          </div>
        );
      }

      // ✅ Start app and render with selected personality
      let selectedPersonality = "kind"; // default
let qrReader;


      document.getElementById("scanButton").addEventListener("click", () => {
        document.getElementById("start-screen").classList.remove("active");
        document.getElementById("scan-screen").classList.add("active");
startQR();
      });

   

  function startQR() {
    const qrResult = document.getElementById("qr-result");
    qrReader = new Html5Qrcode("qr-reader");

    qrReader.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 200 },
      (decodedText) => {
        qrReader.stop();

        qrResult.innerText = `Scanned: ${decodedText}`;


        if (decodedText.includes("kind")) {
          selectedPersonality = "kind";
        } else if (decodedText.includes("cool")) {
          selectedPersonality = "cool";
        } else {
          selectedPersonality = "kind";
        }

        alert(`選ばれた性格: ${selectedPersonality}`);

        document.getElementById("scan-screen").classList.remove("active");
        document.getElementById("ghost-app").classList.add("active");

        setTimeout(() => startApp(), 300);
      },
      (errorMessage) => {
        // console.log("QR scanning...", errorMessage);
      }
    );
  }

  // ✅ Reactが確実にDOMを読み込んでから起動
 

     function startApp() {
  const rootEl = document.getElementById("root");
  if (!rootEl) {
    console.error("Root element not found!");
    return;
  }
  ReactDOM.createRoot(rootEl).render(
    <App personality={selectedPersonality} />
  );
}

    </script>
  </body>
</html>











